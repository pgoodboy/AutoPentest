from subprocess import PIPE, run
import tldextract
import os
import time
from dataclasses import dataclass
#extract domain name
#addr = input("Enter Web App URL : ")
#addr = tldextract.extract(addr)
#addr = "{}.{}".format(addr.domain,addr.suffix)
#print(addr)
#Run kinux command function
def out(command):
    result = run(command, stdout=PIPE, stderr=PIPE, universal_newlines=True, shell=True)
    return result.stdout
#dnsmap
#out("dnsmap "+addr+" | grep "+addr+" > dns.txt")
#lines_seen = set()
#rm duplicated lines
#outfile = open("dnsNoDup.txt", "w")
#for line in open("dns.txt", "r"):
#    if line not in lines_seen:
#        outfile.write(line)
#        lines_seen.add(line)
#outfile.close()

#Loop enum4linux
#outfile=open("smb.txt", "w")
#for line in open("dnsNoDup.txt", "r"):
#    m = out("enum4linux -a "+line)
#    outfile.write(m)
#outfile.close()

#service class
@dataclass
class Services:
    rdp: bool
    ftp: bool
    ssh: bool
    telnet: bool
    mysql: bool
    vnc: bool
    ipO: str

#obj arr
serviceArr=[]

#nmap
fullPort = out("nmap -A -sV -iL dnsNoDup.txt -oG output.grep") #removed -p- arg for faster testing
if os.path.exists("portList.txt"):
  os.remove("portList.txt")
a= out('./porttest.sh')
count = 0
ip = ""
webaddr = ""
#var for obj
arrIndex = 0
rdpB= False
ftpB= False
sshB= False
telnetB= False
mysqlB= False
vncB= False
ip = ''

for line in open("portList.txt", "r"):
    if line != "END\n":
        if count == 0 :
            ip = line.rstrip()
            count = count+1
        else:
            if line == '22\n':
                sshB = True
            if line == '23\n':
                telnetB = True
            if line == '21\n':
                ftpB = True
            if line == '3306\n':
                mysqlB = True
            if line == '3389\n':
                rdpB = True
            if line == '5800\n' or line == '5900\n':
                vncB = True
            add = ip+":"+line
            webaddr = webaddr+ add
    else:
        ip = ''
        count = 0
        serviceArr[arrIndex] = Services(rdp=rdpB,ftp=ftpB,ssh=sshB,telnet=telnetB,mysql=mysqlB,vnc=vncB,ipO=ip)
        arrIndex = arrIndex+1
        rdpB= False
        ftpB= False
        sshB= False
        telnetB= False
        mysqlB= False
        vncB= False
outfile = open("portList.txt", "w")
outfile.write(webaddr)
outfile.close()
#Loop dirb
outfile = open("direct.txt", "w")
for line in open("portList.txt", "r"):
    m = out("dirb http://"+line)
    outfile.write(m)
outfile.close()
#get directories
out("./dirgrep.sh")
#get file names
out("./filegrep.sh")

#hydra
if os.path.exists("cracked.txt"):
    os.remove("cracked.txt")
for x in serviceArr:
    if x.rdp == True:
        out("hydra -L /usr/share/metasploit-framework/data/wordlists/unix_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt "+x.ipO+" rdp >> cracked.txt")
    if x.ftp == True:
        out("hydra -L /usr/share/metasploit-framework/data/wordlists/unix_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt "+x.ipO+" ftp >> cracked.txt")
    if x.ssh == True:
        out("hydra -L /usr/share/metasploit-framework/data/wordlists/unix_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt "+x.ipO+" ssh >> cracked.txt")
    if x.telnet == True:
        out("hydra -L /usr/share/metasploit-framework/data/wordlists/unix_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt "+x.ipO+" telnet >> cracked.txt")
    if x.mysql == True:
        out("hydra -L /usr/share/metasploit-framework/data/wordlists/unix_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt "+x.ipO+" mysql >> cracked.txt")
    if x.vnc == True:
        out("hydra -L /usr/share/metasploit-framework/data/wordlists/unix_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt "+x.ipO+" vnc >> cracked.txt")

#XSS
outfile = open("XSS.txt", "w")
for line in open("portList.txt", "r"):
    m = out("python ./Tools/xsssniper/xsssniper.py -u http://"+line)
    outfile.write(m)